---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# microData

<!-- badges: start -->
<!-- badges: end -->

The goal of microData is to assist the process of obtaining complex metadata of datasets provided by different organizations. At the moment, it supports four organizations, namely, World bank, FAO, UNHCR and IHSN. It can extract the names of available surveys along with their necessary metadata. Moreover, it has an ability to assist obtaining the names of variables from specific survey along with their labels. It enables you to select only variables that you are interested in and rename them while assigning variable descriptions as their label attributes. For this process to happen, you must have an excel installed on your local machine.

## Installation

You can install the development version of microData from [GitHub](https://github.com/GutUrago/microData) with:

``` r
# install.packages("devtools")
devtools::install_github("GutUrago/microData")
```

## Surveys

This package helps you to see all available surveys published by specific organization. In addition it returns a data table with four columns. The first column is a country where the survey is collected, second column is the year, third column is the catalog number of the survey and last column is the title of the survey. Out of these details catalog number is used as a unique identifier of the survey throughout the data extraction process.


```{r results='asis', warning=FALSE, message=FALSE}
library(microData)
sv <- surveys(org = "unhcr")
sv |> head() |> kableExtra::kable()

```




## Metadata

You can extract all details of provided files by an organization. Sometimes these surveys are from external organizations. In that case microData cannot extract its metadata. But it still gives a hint what to do. For instance, lets try extract the metadata of "Humanitarian Situation Monitoring Round 1, 2022" survey collected from Afghanistan in 2022 and published by UNHCR with unique catalog number '1000'.

```{r eval = FALSE}
metadata(catalog = 1000, org = "unhcr")
# Error in value[[3L]](cond) : 
#  Catalog number 1000 doesn't exist within unhcr organization or no metadata is provided. Check if the data is from external organization using: https://microdata.unhcr.org/index.php/catalog/1000/get-microdata
> 
```

As you can see it couldn't extract. If you read the returned error carefully, it suggests possible solutions. In this case, if you we go and visit the link we see that the data is actually from external repository.
![The website](man/figures/README-get-data.png)

Lets extract the metadata of "COVID-19 National Panel Phone Survey 2020, Wave 1" survey collected from Djibouti in 2020 and published by UNHCR with unique catalog number '397'. It returns five key information about each data files such as description and number of variables. The third column, which is File name, is very important for next step.

```{r results='asis'}
md <- metadata(catalog = 397, org = "unhcr")
kableExtra::kable(md)
```


## Dictionary

The function `dictionary()` helps to extract provided variables along with their descriptions using catalog and file name. The filename argument accepts both "File name" value or "'File name'?file_name='Data file'". If you are working with many data files, I recommend using the structure that includes 'Data file' since it helps you later identify them while importing.

```{r results='asis'}
dct <- dictionary(catalog = 397, filename = "F1", 
                  org = "unhcr", namecol = FALSE)
# we can also use 
# dictionary(catalog = 397, org = "unhcr",
#            filename = "F1?file_name=ecv_breadwinners_wave1.dta", 
#            namecol = FALSE)

# gt::gt(dct)
kableExtra::kable(dct)
```

# Creating Workbook              

For excel table manipulations, this package depends on `openxlsx` package. So, I recommend to use that package to organize workbook instead of this function if you are familiar with its the usage.

```{r eval=FALSE}
wb <- new_workbook()    # Run this code only once
```


# Dictionary to Workbook

Multiple dictionary files can be written to the same workbook but different sheets as follows. Give descriptive sheet names and don't set `namecol` argument to `FALSE`. See documentation of the function.

```{r eval=FALSE}
dictionary(catalog = 397, filename = "F1", 
                  org = "unhcr") |> 
        to_workbook(wb, "breadwinners")
dictionary(catalog = 397, filename = "F1", 
                  org = "unhcr") |> 
        to_workbook(wb, "employment")
```

Then, save your workbook to local machine.

```{r eval=FALSE}
openxlsx::saveWorkbook(wb, "My workbook.xlsx")
```


# Importing Data

Before importing the data, you have to open your excel and set the names of variable of interest under the name column. This function only selects variables with the name provided under this column and sets attributes including new name and descriptions.

```{r eval=FALSE}
my_data <- import_csv(data = "ecv_breadwinners_wave1.dta", 
                      excel = "My workbook.xlsx", 
                      sheet = "breadwinners")
```



